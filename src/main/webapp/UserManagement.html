<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />

  <link rel="icon" type="image/x-icon" href="./static/image/logo.png">

  <link rel="stylesheet" href="./static/css/Admin/style.css" />
  <link rel="stylesheet" href="./static/css/Admin/styleguide.css" />

  <link rel="stylesheet" href="./static/css/Admin/dropdown.css" />
  
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>

  <style>
    .view {
      width: 75vw;
      height: 90vh;
      /* background-color: red; */
      overflow: auto;
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      /* 允许自动换行 */
      justify-content: flex-start;
      /* 从左到右排列 */
      align-content: flex-start;
      /* 从上到下排列 */
    }

    .userbox {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      border: 1px solid #C5C5C5;
      margin: 1.50vh 0;
      /* padding: 0.50vw; */
      height: 20vh;
      width: 70vw;
      background-color: #D9D9D9;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .userbox .user-info {
      flex-grow: 1;

      margin: 0vw 1vw;
    }

    .userbox p {
      /* margin: 5px; */
      /* 每個段落的間距 */
      font-family: Arial, sans-serif;
      /* 字體 */
    }

    .userbox .user-details {
      box-sizing: border-box;
      width: 75%;
    }


    .userbox .profile {
      width: 30%;
      /* 左侧图片占宽度的 30% */
      height: auto;
      /* 自适应高度 */
      border-radius: 50%;
      object-fit: cover;
      /* 缩放图片以适应框 */
      padding: 3.1%;
    }

    .userbox .user-manage {
      box-sizing: border-box;
      background-color: #C5C5C5;
      display: flex;

      gap: 40px;

      width: 25%;
      height: 100%;
      justify-content: center;
      align-items: center;
    }

    .user-manage .user-button {
      justify-content: space-between;
      border: none;
    
    }
  </style>
</head>

<body style="display: flex; flex-direction: column;">
  <header style="display: flex;  align-items: center; background-color: #54AABB; overflow: visible;">

    <div class="head"
      style="width: 100vw; height: 10vh; display: flex; flex-direction: row;  justify-content: space-between; align-items: center; background-color: #54AABB; overflow: visible; padding-left: 5vh; padding-right: 5vh;">
      <div style="display: flex; flex-direction: row; align-items: center; gap: 16px;">
        <a href="./NoteManagement.html"><img src="./static/image/logo.png" style="height: 8vh; width: 8vh;"></a>
        <span style="color: #FFFFFF; font-size: 36px; font-weight: bolder; font-family: monospace;">MISNOTE</span>
      </div>
      <!-- Search Box -->
      <div style="width: 30vw; display: flex; flex-direction: row;justify-content: center; align-items: center;">
        <!-- <div
          style="height: 4vh; width: auto; background-color: #F5F5F5; display: flex; justify-items: center; align-items: center; ">
          <input type="text" placeholder="搜尋"
            style="height: 5vh; width: 20vw; float: none; text-align: left; border-style: none;">
        </div>

        <button
          style="background-color: #e7e7e7; width: 5vh; height: 5vh; display: flex; justify-items: center; align-items: center;">
          <img style="box-sizing: border-box; width: 100%; height: auto;" src="./static/icon/icons8-search-64.png">
        </button> -->

        <!-- <div class="input-group mb-1">
          <input id="searchInput" type="text" class="form-control" placeholder="搜尋" aria-label="Recipient's username"
            aria-describedby="button-addon2" onkeydown="handleKeyPress(event)">
          <button onclick="search(document.getElementById('searchInput').value)" class="btn btn-outline-secondary"
            style="background-color: #F5F5F5;" type="button" id="searchBtn">Search</button>
        </div> -->

        <!--<div class="dropdown">
          <button onclick="myFunction()" class="dropbtn">筆記</button>
          <div id="myDropdown" class="dropdown-content" style="box-sizing: border-box; width: 100%;">
            <button>筆記</button>
            <button>會員</button>
          </div>
        </div>-->
      </div>

      <!-- Buttons on Right -->
      <div style=" display: flex; align-items: center; gap: 8px;">

        <!-- 通知列表 -->
        <!-- <div class="dropdown">
          <img class="dropbtn" onclick="notificationShow()"
            style="width: 48px; height: 48px; border-radius: 50%; background-color: #F5F5F5; padding: 8px;"
            src="./static/icon/icons8-notification-64.png">
          <div id="notification_panel" class="dropdown-content" style="box-sizing: border-box; width: 200px;">
          </div>
          <div id="notification_indicator" class="notification-indicator"></div>
        </div> -->

        <!-- 使用者資訊+登出 -->
        <div class="dropdown">
          <img onclick="userFunction()" class="dropbtn" style="width: 48px; height: 48px; border-radius: 50%; padding: 0;"
            src="./Adminstatic/icon/engineer.png">
          <div id="function_user" class="dropdown-content" style="box-sizing: border-box; width: 200%;">
            <button onclick="logout()">登出</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <script>
    function myFunction() {
      document.getElementById("myDropdown").classList.toggle("show");
    }

    // Close the dropdown menu if the user clicks outside of it
    window.onclick = function (event) {
      if (!event.target.matches('.dropbtn')) {
        var dropdowns = document.getElementsByClassName("dropdown-content");
        var i;
        for (i = 0; i < dropdowns.length; i++) {
          var openDropdown = dropdowns[i];
          if (openDropdown.classList.contains('show')) {
            openDropdown.classList.remove('show');
          }
        }
      }
    }

    function userFunction() {
      document.getElementById("function_user").classList.toggle("show");
    }
  </script>

  <div style="display: flex; flex-direction: row; width: 100vw; height: 90vh;">



    <div
      style="width: 25vw; height: 90vh; display: flex; flex-direction: column; justify-content: space-between; background-color: #F5F5F5; ">

      <div style="box-sizing: border-box; width: 100%; height: fit-content; display: flex; flex-direction: column;">
        <a href="NoteManagement.html" id="showNote">
          <button type="button" class="admin-console-drawer-button">
            <img style="width: 5vh; height: 5vh;" src="./static/icon/material-symbols-note.png" />
            <span style="font-size: 4vh; font-weight: bold;">筆記管理</span>
          </button>
        </a>

        <a href="UserManagement.html" id="showNote">
          <button type="button" class="admin-console-drawer-button">
            <img style="width: 5vh; height: 5vh;" src="./static/icon/icons8-user-settings-64.png" />
            <span style="font-size: 4vh; font-weight: bold;">用戶管理</span>
          </button>
        </a>

        <a href="AdminManagement.html" id="showNote">
          <button type="button" class="admin-console-drawer-button">
            <img style="width: 5vh; height: 5vh;" src="./static/icon/icons8-user-settings-64.png" />
            <span style="font-size: 4vh; font-weight: bold;">管理員管理</span>
          </button>
        </a>
      </div>

      <!-- <div style="box-sizing: border-box; width: 100%; height: fit-content; display: flex; flex-direction: column;">
        <button class="admin-console-drawer-button">
          <img style="width: 5vh; height: 5vh;" src="./static/icon/icons8-add-user-64.png" />
          <span style="font-size: 4vh; font-weight: bold;">新增用戶</span>
        </button>
      </div> -->
    </div>

    <div class="view"
      style="width: 75vw; height: 90vh; display: flex; justify-content: center; background-color:rgba(205, 198, 198, 0.39);  overflow: auto;">
      <div class="user-list-container">
      </div>
    </div>


    <script>
      function getHTML(template) {
        return template.join('\n');
      }

      // // 創建用戶列表的示例數據
      // const usersData = [
      //   { name: 'User 1', email: 'user1@example.com', notecount: '11' },
      //   { name: 'User 2', email: 'user2@example.com', notecount: '13' },
      // ];

      function showUserManagement() {
        const userListContainer = document.querySelector('.user-list-container');
        if (userListContainer) {
          getUserAll();
          // renderUsers(userListContainer, usersData['UserList']);
        } else {
          console.error('.user-list-container element not found');
        }
      }

      // Automatically call showUserManagement when the page is loaded
      document.addEventListener('DOMContentLoaded', function () {
        showUserManagement();
      });


      /// 取得所有用戶
      async function getUserAll() {
        const userListContainer = document.querySelector('.user-list-container');

        await fetch('/SA/api/User.do', {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' },
        }).then((response) => response.json())
          .then((data) => {
            console.log(data);

            renderUsers(userListContainer, data['response']['UserList']);
          })
          .catch((error) => {
            console.error('Error:', error);
          });
      }

      /// 印出所有用戶
      function renderUsers(container, users) {
        container.innerHTML = ''; // 清除之前的内容
        // Create a container for each user and add user data

        users.forEach(user => {
          // 是否為被禁之圖像位置
          var icon_IFBan;

          // Locked User
          if (user.Lock == 1) {
            icon_IFBan = "./static/icon/icons8-no-entry-64.png";
          }
          // Normal User
          else {
            icon_IFBan = "./static/icon/icons8-check-64.png";
          }

          var userHtmlArray = [
            '<div class="userbox" data-user-id="' + user.Account + '">',
            '  <div class="user-details" style="display: flex; flex-direction: row; align-items: center; cursor: pointer; " onclick="window.location.href=\'./UserProfile.html?Account=' + user.Account + '\'">',
            '    <img class="profile" style="width: 15vh; height: 15vh;" src="./static/icon/no-user.png" />',
            '    <div class="user-info">',
            '      <p class="text-1">Name: ' + user.Name + '</p>',
            '      <p class="text-2">Email: ' + user.Account + '</p>',
            '      <p class="text-3">Notecount: ' + ' -- ' + '</p>',
            '    </div>',
            '  </div>',
            '  <div class="user-manage">',
            '    <img id="btn-del" class="user-button" data-user-id="' + user.Account + '" style="width: 8vh; height: 8vh; cursor: pointer;" src="./static/icon/icons8-delete-64.png" alt="" >',
            '    <img id="btn-ban" class="user-button" data-user-id="' + user.Account + '" style="width: 8vh; height: 8vh; cursor: pointer;" src="' + icon_IFBan + '" alt="">',
            '  </div>',
            '</div>',
          ];

          const userElement = document.createElement('div');
          userElement.innerHTML = getHTML(userHtmlArray);

          // Add the user element to the user-list-container
          container.appendChild(userElement);

          document.querySelector('[data-user-id="' + user.Account + '"][id="btn-del"]').addEventListener('click', () => { delUser(user.Account); });
          document.querySelector('[data-user-id="' + user.Account + '"][id="btn-ban"]').addEventListener('click', () => { banUser(user.Account); });
        });
      }

      /// 刪除用戶
      async function delUser(userId) {
        await fetch('/SA/api/User.do', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ Account: userId }),
        }).then((response) => response.json())
          .then((data) => {
            console.log('%c - Delete User:' + userId, 'color: orange');

            document.querySelector('[data-user-id="' + userId + '"]').remove();

            window.alert(data['message']);
          })
          .catch((error) => {
            console.error('Error:', error);
          });
      }

      /// 封鎖用戶
      async function banUser(userId) {
        await fetch('/SA/api/User.do', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ Account: userId, Lock: 0 }),
        }).then((response) => response.json())
          .then((data) => {
            // unLock --> Lock
            if (document.querySelector('#btn-ban[data-user-id="' + userId + '"]').getAttribute('src') == "./static/icon/icons8-check-64.png") {
              console.log('%c > Lock User:' + userId, 'color: orange');

              document.querySelector('#btn-ban[data-user-id="' + userId + '"]').src = "./static/icon/icons8-no-entry-64.png";
            }
            // Lock --> unLock
            else {
              console.log('%c > unLock User:' + userId, 'color: orange');

              document.querySelector('#btn-ban[data-user-id="' + userId + '"]').src = "./static/icon/icons8-check-64.png";
            }

            window.alert(data['message']);
          })
          .catch((error) => {
            console.error('Error:', error);
          });
      }
    </script>
</body>

<script>
  var noti_click = 0;
  var notificationIndicator = document.getElementById('notification_indicator');

  const currentAdmin = Cookies.get('storedAdminEmail');

  console.log('Cookie Admin: ' + currentAdmin);

  function redirectToNoteView(noteId) {
    // Construct the URL with the note ID as a query parameter
    console.log(noteId);
    const noteViewURL = `./NoteView.html?NoteID=` + String(noteId);

    // 使用 window.open() 打开新的浏览器窗口或标签页
    window.open(noteViewURL, '_blank');
    console.log("success");

  }

  function myFunction() {
    document.getElementById("myDropdown").classList.toggle("show");
  }

  // Close the dropdown menu if the user clicks outside of it
  window.onclick = function (event) {
    noti_click++;
    if (!event.target.matches('.dropbtn')) {
      var dropdowns = document.getElementsByClassName("dropdown-content");
      var i;
      for (i = 0; i < dropdowns.length; i++) {
        var openDropdown = dropdowns[i];
        if (openDropdown.classList.contains('show')) {
          openDropdown.classList.remove('show');
        }
      }
    }
  }

  function userFunction() {
    document.getElementById("function_user").classList.toggle("show");
  }

  function search(newParam) {
    if (newParam === null || newParam.trim() === "") {
      alert("請填入關鍵字！");
    }
    else {
      // 更新或添加名为 Search 的参数值
      urlParams.set('Search', newParam);

      // 构建新的 URL
      const newURL = `${window.location.origin}${window.location.pathname}?${urlParams.toString()}`;

      // 将新的 URL 设置到浏览器地址栏中
      window.history.replaceState({}, document.title, newURL);

      updateContent();
    }
  }

  function logout() {
    // 清除用戶資料
    Cookies.remove('storedAdminEmail');
    Cookies.remove('storedAdminPassword');
    // 導回登入
    window.location.href = './Adminindex.html';
  }
</script>