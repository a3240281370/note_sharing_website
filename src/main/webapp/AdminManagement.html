<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />

  <link rel="icon" type="image/x-icon" href="./static/image/logo.png">

  <link rel="stylesheet" href="./static/css/Admin/style.css" />
  <link rel="stylesheet" href="./static/css/Admin/styleguide.css" />

  <link rel="stylesheet" href="./static/css/Admin/dropdown.css" />

  <link rel="stylesheet" type="text/css" href="./static/css/Register/common.css" />
  <link rel="stylesheet" type="text/css" href="./static/css/Register/fonts.css" />
  <link rel="stylesheet" type="text/css" href="./static/css/Register/tailwind.css" />

  <script src="https://code.jquery.com/jquery-1.12.4.js" integrity="sha256-Qw82+bXyGq6MydymqBxNPYTaUXXq7c8v3CwiYwLLNXU="
    crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>

  <link rel="stylesheet" type="text/css" href="https://unpkg.com/aos@2.3.1/dist/aos.css" />

  <script type="text/javascript" src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

  <script type="text/javascript" src="https://unpkg.com/sticky-js@1.3.0/dist/sticky.min.js"></script>

  <style>
    .view {
      width: 75vw;
      height: 90vh;
      /* background-color: red; */
      overflow: auto;
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      /* 允许自动换行 */
      justify-content: flex-start;
      /* 从左到右排列 */
      align-content: flex-start;
      /* 从上到下排列 */
    }

    .userbox {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      border: 1px solid #C5C5C5;
      margin: 1.50vh 0;
      /* padding: 0.50vw; */
      height: 20vh;
      width: 70vw;
      background-color: #D9D9D9;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .userbox .user-info {
      flex-grow: 1;

      margin: 0vw 1vw;
    }

    .userbox p {
      /* margin: 5px; */
      /* 每個段落的間距 */
      font-family: Arial, sans-serif;
      /* 字體 */
    }

    .userbox .user-details {
      box-sizing: border-box;
      width: 75%;
    }


    .userbox .profile {
      width: 30%;
      /* 左侧图片占宽度的 30% */
      height: auto;
      /* 自适应高度 */
      border-radius: 50%;
      object-fit: cover;
      /* 缩放图片以适应框 */
      padding: 3.1%;
    }

    .userbox .user-manage {
      box-sizing: border-box;
      background-color: #C5C5C5;
      display: flex;

      width: 25%;
      height: 100%;
      justify-content: center;
      align-items: center;
    }

    .user-manage .user-button {
      border: none;
    }
  </style>

  <link rel="stylesheet" href="./static/css/dropdown.css" />
  <link rel="stylesheet" href="./static/css/header_main.css" />
</head>

<body style="display: flex; flex-direction: column;">
  <header style="display: flex;  align-items: center; background-color: #54AABB; overflow: visible;">

    <div class="head"
      style="width: 100vw; height: 10vh; display: flex; flex-direction: row;  justify-content: space-between; align-items: center; background-color: #54AABB; overflow: visible; padding-left: 5vh; padding-right: 5vh;">
      <div style="display: flex; flex-direction: row; align-items: center; gap: 16px;">
        <a href="./NoteManagement.html"><img src="./static/image/logo.png" style="height: 8vh; width: 8vh;"></a>
        <span style="color: #FFFFFF; font-size: 36px; font-weight: bolder; font-family: monospace;">MISNOTE</span>
      </div>
      <!-- Search Box -->
      <div style="width: 30vw; display: flex; flex-direction: row;justify-content: center; align-items: center;">
        <!-- <div
          style="height: 4vh; width: auto; background-color: #F5F5F5; display: flex; justify-items: center; align-items: center; ">
          <input type="text" placeholder="搜尋"
            style="height: 5vh; width: 20vw; float: none; text-align: left; border-style: none;">
        </div>

        <button
          style="background-color: #e7e7e7; width: 5vh; height: 5vh; display: flex; justify-items: center; align-items: center;">
          <img style="box-sizing: border-box; width: 100%; height: auto;" src="./static/icon/icons8-search-64.png">
        </button> -->

        <!-- <div class="input-group mb-1">
          <input id="searchInput" type="text" class="form-control" placeholder="搜尋" aria-label="Recipient's username"
            aria-describedby="button-addon2" onkeydown="handleKeyPress(event)">
          <button onclick="search(document.getElementById('searchInput').value)" class="btn btn-outline-secondary"
            style="background-color: #F5F5F5;" type="button" id="searchBtn">Search</button>
        </div> -->

        <!--<div class="dropdown">
          <button onclick="myFunction()" class="dropbtn">筆記</button>
          <div id="myDropdown" class="dropdown-content" style="box-sizing: border-box; width: 100%;">
            <button>筆記</button>
            <button>會員</button>
          </div>
        </div>-->
      </div>

      <!-- Buttons on Right -->
      <div style=" display: flex; align-items: center; gap: 8px;">

        <!-- 通知列表 -->
        <!-- <div class="dropdown">
          <img class="dropbtn" onclick="notificationShow()"
            style="width: 48px; height: 48px; border-radius: 50%; background-color: #F5F5F5; padding: 8px;"
            src="./static/icon/icons8-notification-64.png">
          <div id="notification_panel" class="dropdown-content" style="box-sizing: border-box; width: 200px;">
          </div>
          <div id="notification_indicator" class="notification-indicator"></div>
        </div> -->

        <!-- 使用者資訊+登出 -->
        <div class="dropdown">
          <img onclick="userFunction()" class="dropbtn"
            style="width: 48px; height: 48px; border-radius: 50%; padding: 0;" src="./Adminstatic/icon/engineer.png">
          <div id="function_user" class="dropdown-content" style="box-sizing: border-box; width: 200%;">
            <button onclick="logout()">登出</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <script>
    function myFunction() {
      document.getElementById("myDropdown").classList.toggle("show");
    }

    // Close the dropdown menu if the user clicks outside of it
    window.onclick = function (event) {
      if (!event.target.matches('.dropbtn')) {
        var dropdowns = document.getElementsByClassName("dropdown-content");
        var i;
        for (i = 0; i < dropdowns.length; i++) {
          var openDropdown = dropdowns[i];
          if (openDropdown.classList.contains('show')) {
            openDropdown.classList.remove('show');
          }
        }
      }
    }

    function userFunction() {
      document.getElementById("function_user").classList.toggle("show");
    }
  </script>

  <div style="display: flex; flex-direction: row; width: 100vw; height: 90vh;">



    <div
      style="width: 25vw; height: 90vh; display: flex; flex-direction: column; justify-content: space-between; background-color: #F5F5F5; ">

      <div style="box-sizing: border-box; width: 100%; height: fit-content; display: flex; flex-direction: column;">
        <a href="NoteManagement.html" id="showNote">
          <button type="button" class="admin-console-drawer-button">
            <img style="width: 5vh; height: 5vh;" src="./static/icon/material-symbols-note.png" />
            <span style="font-size: 4vh; font-weight: bold;">筆記管理</span>
          </button>
        </a>

        <a href="UserManagement.html" id="showNote">
          <button type="button" class="admin-console-drawer-button">
            <img style="width: 5vh; height: 5vh;" src="./static/icon/icons8-user-settings-64.png" />
            <span style="font-size: 4vh; font-weight: bold;">用戶管理</span>
          </button>
        </a>

        <a href="AdminManagement.html" id="showNote">
          <button type="button" class="admin-console-drawer-button">
            <img style="width: 5vh; height: 5vh;" src="./static/icon/icons8-user-settings-64.png" />
            <span style="font-size: 4vh; font-weight: bold;">管理員管理</span>
          </button>
        </a>
      </div>

      <!-- 新增管理員 input -->
      <div
        style="box-sizing: border-box; width: 100%; flex-grow: 1; background-color: #FFFFFF; justify-content: center; align-items: center; padding: 5vh; ">
        <div class="w-full h-auto flex flex-col items-center relative mt-4">
          <div class="flex flex-col w-full h-auto relative">
            <div
              class="font-normal text-[12px] leading-none font-BIZUDGothic text-[rgb(51,51,51)] tracking-[0.3px] w-auto h-auto mx-4">
              電子信箱
            </div>
          </div>
          <div
            class="flex flex-col bg-neutral-100 rounded-md outline outline-[rgb(217,217,217)] outline-[0.5px] outline-offset-[-0.5px] w-full h-auto relative mt-2">
            <div class="rounded-md w-auto h-auto flex justify-between items-center content-start gap-x-2 relative">
              <div class="flex flex-col w-full h-auto relative min-w-0 mt-3.5 mb-3.5 ml-4 mr-4">
                <div class="flex flex-col w-auto h-auto relative">
                  <input type="email" placeholder="電子信箱" id="admin_email"
                    class="flex items-end font-normal text-[18px] leading-[1.33] font-Roboto text-[rgb(128,128,128)] w-auto h-auto bg-none input">
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="w-full h-auto flex flex-col items-center relative mt-4">
          <div class="flex flex-col w-full h-auto relative">
            <div
              class="font-normal text-[12px] leading-none font-BIZUDGothic text-[rgb(51,51,51)] tracking-[0.3px] w-auto h-auto mx-4">
              密碼
            </div>
          </div>
          <div
            class="flex flex-col bg-neutral-100 rounded-md outline outline-[rgb(217,217,217)] outline-[0.5px] outline-offset-[-0.5px] w-full h-auto relative mt-2">
            <div class="rounded-md w-auto h-auto flex justify-between items-center content-start gap-x-2 relative">
              <div class="flex flex-col w-full h-auto relative min-w-0 mt-3.5 mb-3.5 ml-4">
                <div class="flex flex-col w-auto h-auto relative">
                  <input type="password" placeholder="帳戶密碼" id="admin_password"
                    class="flex items-end font-normal text-[18px] leading-[1.33] font-Roboto text-[rgb(128,128,128)] w-auto h-auto input">

                </div>
              </div>
              <!-- 顯示密碼 -->
              <button class="w-8 h-8 p-0 bg-transparent border-none focus:outline-none mr-4"
                onclick="togglePasswordVisibility()" id="submit">
                <img class="w-full h-full object-cover" src="./static/icon/simple_eye_icon.png" alt="alt text"
                  id="eyeIcon" />
              </button>
            </div>
          </div>
        </div>
      </div>

      <div style="box-sizing: border-box; width: 100%; height: fit-content; display: flex; flex-direction: column;">
        <button class="admin-console-drawer-button" id="btn-addAdmin">
          <img style="width: 5vh; height: 5vh;" src="./static/icon/icons8-add-user-64.png" />
          <span style="font-size: 4vh; font-weight: bold;">新增管理員</span>
        </button>
      </div>
    </div>

    <div class="view"
      style="width: 75vw; height: 90vh; display: flex; justify-content: center; background-color:rgba(205, 198, 198, 0.39);  overflow: auto;">
      <div class="admin-list-container">
      </div>
    </div>


    <script>
      function getHTML(template) {
        return template.join('\n');
      }

      // // 創建用戶列表的示例數據
      // const usersData = [
      //   { name: 'User 1', email: 'user1@example.com', notecount: '11' },
      //   { name: 'User 2', email: 'user2@example.com', notecount: '13' },
      // ];

      function showAdminManagement() {
        const adminListContainer = document.querySelector('.admin-list-container');
        if (adminListContainer) {
          getAdminAll();
          // renderUsers(userListContainer, usersData['UserList']);
        } else {
          console.error('.admin-list-container element not found');
        }
      }

      // Automatically call showUserManagement when the page is loaded
      document.addEventListener('DOMContentLoaded', function () {
        showAdminManagement();
      });


      /// 取得所有用戶
      async function getAdminAll() {
        const adminListContainer = document.querySelector('.admin-list-container');

        await fetch('/SA/api/Admin.do', {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' },
        }).then((response) => response.json())
          .then((data) => {
            console.log(data);

            renderAdmins(adminListContainer, data['response']['AdminList']);
          })
          .catch((error) => {
            console.error('Error:', error);
          });
      }

      /// 印出所有用戶
      function renderAdmins(container, Admins) {
        container.innerHTML = ''; // 清除之前的内容
        // Create a container for each user and add user data

        Admins.forEach(admin => {

          var adminHtmlArray = [
            '<div class="userbox" data-admin-id="' + admin.Account + '">',
            '  <div class="user-details" style="display: flex; flex-direction: row; align-items: center; ">',
            '    <img class="profile" style="width: 21vh; height: 21vh;" src="./static/icon/no-user.png" />',
            '    <div class="user-info">',
            '      <p class="text-2">Email: ' + admin.Account + '</p>',
            // '      <p class="text-3">Notecount: ' + ' -- ' + '</p>',
            '    </div>',
            '  </div>',
            '  <div class="user-manage">',
            '    <img id="btn-del" class="user-button" data-admin-id="' + admin.Account + '" style="width: 8vh; height: 8vh; cursor: pointer;" src="./static/icon/icons8-delete-64.png" alt="" >',
            // '    <img style="width: 8vh; height: 8vh; cursor: pointer;" src="./static/icon/icons8-edit-64.png" alt="">',
            '  </div>',
            '</div>',
          ];

          const adminElement = document.createElement('div');
          adminElement.innerHTML = getHTML(adminHtmlArray);

          // Add the user element to the user-list-container
          container.appendChild(adminElement);

          document.querySelector('[data-admin-id="' + admin.Account + '"][id="btn-del"]').addEventListener('click', () => { delAdmin(admin.Account); });
        });
      }

      /// 刪除用戶
      async function delAdmin(adminId) {
        await fetch('/SA/api/Admin.do', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ Account: adminId }),
        }).then((response) => response.json())
          .then((data) => {
            console.log('%c - Delete Admin:' + adminId, 'color: orange');

            document.querySelector('[data-admin-id="' + adminId + '"]').remove();

            window.alert(data['message']);
          })
          .catch((error) => {
            console.error('Error:', error);
          });
      }
    </script>
</body>

<!-- 新增管理員 -->
<script>
  $(document).ready(function () {
    AOS.init();
    new Sticky('.sticky-effect');


    // 處理表單點擊事件
    var $addAdmin = $('#btn-addAdmin');
    $addAdmin.click(function () {
      submit();
    });

    function submit() {
      var email = $('#admin_email').val();
      var password = $('#admin_password').val();

      var email_rule = /^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z]+$/;
      //包含至少一個字母。包含至少一個數字。總長度至少為 8 個字符。
      var password_rule = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$/;

      if (!email_rule.test(email)) {
        alert("Email格式不符！");
      }
      else if (!password_rule.test(password)) {
        alert("密碼格式不符，長度至少8，且至少包含一個數字和英文字母！");
      }
      else {
        // 將資料組成JSON格式
        var data_object = {
          "Account": email,
          "Password": password,
          // 代碼 -- 註冊為除 1 以外
          "Instruction": 2,
        };

        // 將JSON格式轉換成字串
        var data_string = JSON.stringify(data_object);

        // 發出POST的AJAX請求
        $.ajax({
          type: "POST",
          url: "/SA/api/Admin.do",
          data: data_string,
          crossDomain: true,
          cache: false,
          //dataType: 'json',
          timeout: 5000,
          success: function (response) {
            var res = jQuery.parseJSON(response);
            if (res.status === "200") {
              // 清空輸入
              document.getElementById('admin_email').innerText = "";
              document.getElementById('admin_password').innerText = "";

              alert("成功新增管理員！");
              // 刷新頁面
              window.location.reload();
            } else {
              // 註冊失敗，檢查重複的錯誤
              if (res.message.includes("已有相同的用戶名稱")) {
                alert("已有相同的用戶名稱註冊！");
              } else if (res.message.includes("已有相同的電子信箱")) {
                alert("已有相同的電子信箱註冊！");
              } else if (res.message.includes("已有相同的密碼")) {
                alert("已有相同的密碼註冊！");
              } else {
                alert(res.message);
              }
            }
          },
          error: function () {
            alert("無法連線到伺服器！");
          }
        });
      }
    }
  });

  function togglePasswordVisibility() {
    var passwordInput = document.getElementById("admin_password");
    var eyeIcon = document.getElementById("eyeIcon");

    if (passwordInput.type === "password") {
      passwordInput.type = "text";
      eyeIcon.src = "./static/icon/simple_eye_icon.png"; // Change the source to your hide password icon
    } else {
      passwordInput.type = "password";
      eyeIcon.src = "./static/icon/simple_eye_icon.png"; // Change the source to your show password icon
    }
  }
</script>

<script>
  var noti_click = 0;
  var notificationIndicator = document.getElementById('notification_indicator');

  const currentAdmin = Cookies.get('storedAdminEmail');

  console.log('Cookie Admin: ' + currentAdmin);

  function redirectToNoteView(noteId) {
    // Construct the URL with the note ID as a query parameter
    console.log(noteId);
    const noteViewURL = `./NoteView.html?NoteID=` + String(noteId);

    // 使用 window.open() 打开新的浏览器窗口或标签页
    window.open(noteViewURL, '_blank');
    console.log("success");

  }

  function myFunction() {
    document.getElementById("myDropdown").classList.toggle("show");
  }

  // Close the dropdown menu if the user clicks outside of it
  window.onclick = function (event) {
    noti_click++;
    if (!event.target.matches('.dropbtn')) {
      var dropdowns = document.getElementsByClassName("dropdown-content");
      var i;
      for (i = 0; i < dropdowns.length; i++) {
        var openDropdown = dropdowns[i];
        if (openDropdown.classList.contains('show')) {
          openDropdown.classList.remove('show');
        }
      }
    }
  }

  function userFunction() {
    document.getElementById("function_user").classList.toggle("show");
  }

  function search(newParam) {
    if (newParam === null || newParam.trim() === "") {
      alert("請填入關鍵字！");
    }
    else {
      // 更新或添加名为 Search 的参数值
      urlParams.set('Search', newParam);

      // 构建新的 URL
      const newURL = `${window.location.origin}${window.location.pathname}?${urlParams.toString()}`;

      // 将新的 URL 设置到浏览器地址栏中
      window.history.replaceState({}, document.title, newURL);

      updateContent();
    }
  }

  function logout() {
    // 清除用戶資料
    Cookies.remove('storedAdminEmail');
    Cookies.remove('storedAdminPassword');
    // 導回登入
    window.location.href = './Adminindex.html';
  }
</script>